<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络急诊室 | 一键检测 & 修复</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff5a5f;
            --primary-dark: #e04a50;
            --secondary: #4687ff;
            --light: #f5f5f5;
            --dark: #333;
            --gray: #777;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        header {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.2rem;
            text-align: center;
            font-size: 1.4rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .card-title {
            font-size: 1.2rem;
            color: var(--dark);
            margin: 0;
        }

        .card-body {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .input-group {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.2rem;
            flex-wrap: wrap;
        }

        input {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            flex: 1;
            min-width: 120px;
            transition: var(--transition);
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 90, 95, 0.2);
        }

        button {
            cursor: pointer;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        button.secondary {
            background: var(--secondary);
        }

        button.secondary:hover {
            background: #3a75e0;
        }

        button.success {
            background: var(--success);
        }

        button.success:hover {
            background: #218838;
        }

        pre {
            background: #f8f9fa;
            padding: 1.25rem;
            border-left: 4px solid var(--primary);
            overflow-x: auto;
            font-size: 0.9rem;
            border-radius: 0 8px 8px 0;
            margin: 0;
            white-space: pre-wrap;
            flex-grow: 1;
            font-family: 'Fira Code', 'Consolas', monospace;
        }

        .status {
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.75rem 0;
            display: none;
            align-items: center;
            gap: 0.75rem;
        }

        .status.info {
            background: #e8f4fd;
            color: var(--info);
            border-left: 4px solid var(--info);
        }

        .status.success {
            background: #f0f9f0;
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .status.error {
            background: #fdf3f3;
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .tooltip {
            position: relative;
            display: inline-flex;
            margin-left: 0.5rem;
            color: var(--gray);
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: normal;
            line-height: 1.4;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .flex-row {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 0.35rem 0.65rem;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
            background: var(--info);
            color: white;
        }

        .badge.success {
            background: var(--success);
        }

        .badge.danger {
            background: var(--danger);
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                margin: 1rem auto;
                gap: 1rem;
            }

            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            input {
                width: 100%;
            }

            header {
                font-size: 1.2rem;
                padding: 1rem;
            }
        }

        footer {
            text-align: center;
            margin-top: 2rem;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 6px;
            width: 100%;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }

        .progress-bar .progress {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.4s ease;
        }

        .history-btn {
            background: transparent;
            color: var(--gray);
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .history-btn:hover {
            background: #f1f3f5;
            transform: none;
        }

        .result-placeholder {
            color: var(--gray);
            font-style: italic;
        }
        
        /* 新增的连接问题检测样式 */
        .connection-test {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid var(--info);
        }
        
        .test-item {
            display: flex;
            align-items: center;
            margin: 0.75rem 0;
            gap: 0.75rem;
        }
        
        .test-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        .test-content {
            flex: 1;
        }
        
        .test-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .test-desc {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .solution-box {
            background: #f0f9f0;
            border-left: 4px solid var(--success);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin-top: 1rem;
            display: none;
        }
        
        .solution-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .solution-steps {
            padding-left: 1.5rem;
        }
        
        .solution-steps li {
            margin-bottom: 0.5rem;
        }
        
        .solution-code {
            background: #e9ecef;
            padding: 0.75rem;
            border-radius: 4px;
            font-family: monospace;
            margin: 0.5rem 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <header>
        <i class="fas fa-hospital"></i>
        <h1>网络急诊室 · 一键检测 & 修复</h1>
    </header>

    <div class="container">
        <section class="card">
            <div class="card-header">
                <span class="card-number">1</span>
                <h2 class="card-title">本地网络快照</h2>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <button onclick="snap()" id="snapBtn">
                        <i class="fas fa-sync-alt"></i> 刷新网络状态
                    </button>
                    <button class="secondary" onclick="showNetworkDetails()">
                        <i class="fas fa-info-circle"></i> 详细信息
                    </button>
                </div>
                <div id="snapStatus" class="status info"></div>
                <div class="progress-bar" id="snapProgress">
                    <div class="progress"></div>
                </div>
                <pre id="snap"><span class="result-placeholder">点击"刷新"获取网络状态</span></pre>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <span class="card-number">2</span>
                <h2 class="card-title">端口探测</h2>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input id="host" value="example.com" placeholder="域名/IP">
                    <input id="port" value="80" placeholder="端口" style="width:100px">
                    <button onclick="portTest()" id="portBtn">
                        <i class="fas fa-search"></i> 检测端口
                    </button>
                </div>
                <div id="portStatus" class="status info"></div>
                <div class="progress-bar" id="portProgress">
                    <div class="progress"></div>
                </div>
                <pre id="portRes"><span class="result-placeholder">输入地址和端口进行检测</span></pre>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <span class="card-number">3</span>
                <h2 class="card-title">路由追踪</h2>
                <span class="tooltip">
                    <i class="fas fa-question-circle"></i>
                    <span class="tooltiptext">使用WebSocket模拟 traceroute 功能，显示数据包经过的路由节点</span>
                </span>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input id="traceHost" value="example.com" placeholder="域名/IP">
                    <button onclick="traceRun()" id="traceBtn">
                        <i class="fas fa-project-diagram"></i> 开始追踪
                    </button>
                </div>
                <div id="traceStatus" class="status info"></div>
                <div class="progress-bar" id="traceProgress">
                    <div class="progress"></div>
                </div>
                <pre id="traceRes"><span class="result-placeholder">输入目标地址进行路由追踪</span></pre>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <span class="card-number">4</span>
                <h2 class="card-title">DNS 对比</h2>
                <span class="tooltip">
                    <i class="fas fa-question-circle"></i>
                    <span class="tooltiptext">对比不同DNS服务商的解析结果，检测DNS污染或配置问题</span>
                </span>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input id="dnsHost" value="github.com" placeholder="域名">
                    <button onclick="dnsTest()" id="dnsBtn">
                        <i class="fas fa-globe"></i> 解析对比
                    </button>
                </div>
                <div id="dnsStatus" class="status info"></div>
                <div class="progress-bar" id="dnsProgress">
                    <div class="progress"></div>
                </div>
                <pre id="dnsRes"><span class="result-placeholder">输入域名进行DNS解析对比</span></pre>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <span class="card-number">5</span>
                <h2 class="card-title">网络连接问题检测与解决</h2>
                <span class="tooltip">
                    <i class="fas fa-question-circle"></i>
                    <span class="tooltiptext">检测常见的网络连接问题并提供解决方案</span>
                </span>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <button onclick="detectConnectionProblems()" id="detectBtn">
                        <i class="fas fa-heartbeat"></i> 检测连接问题
                    </button>
                    <button class="secondary" onclick="runAllFixes()">
                        <i class="fas fa-magic"></i> 一键修复所有问题
                    </button>
                </div>
                <div id="detectStatus" class="status info"></div>
                <div class="progress-bar" id="detectProgress">
                    <div class="progress"></div>
                </div>
                <div id="connectionResults">
                    <div class="connection-test">
                        <p>点击"检测连接问题"开始诊断您的网络连接...</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <span class="card-number">6</span>
                <h2 class="card-title">生成修复脚本</h2>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input id="fixPort" value="8080" placeholder="端口" style="width:100px">
                    <button onclick="genFix()" id="fixBtn">
                        <i class="fas fa-wrench"></i> 生成脚本
                    </button>
                    <button class="secondary" onclick="copyFw()">
                        <i class="fas fa-copy"></i> 防火墙命令
                    </button>
                </div>
                <div id="fixStatus" class="status info"></div>
                <pre id="fixCmd"><span class="result-placeholder">输入端口号生成修复脚本</span></pre>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <span class="card-number">7</span>
                <h2 class="card-title">完整报告</h2>
            </div>
            <div class="card-body">
                <div class="flex-row">
                    <button onclick="generateReport()" class="success">
                        <i class="fas fa-file-alt"></i> 生成报告
                    </button>
                    <button onclick="copyReport()">
                        <i class="fas fa-copy"></i> 复制报告
                    </button>
                    <button class="secondary" onclick="saveReport()">
                        <i class="fas fa-download"></i> 保存报告
                    </button>
                    <button class="history-btn" onclick="clearHistory()">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div id="reportStatus" class="status info"></div>
                <pre id="report"><span class="result-placeholder">生成完整的网络诊断报告</span></pre>
            </div>
        </section>
    </div>

    <footer>
        <p>网络急诊室 &copy; 2023 - 一键诊断和修复网络问题</p>
    </footer>

    <script>
        // 工具函数
        const $ = q => document.querySelector(q);
        const $$ = q => document.querySelectorAll(q);

        // 显示状态消息
        function showStatus(id, message, type = 'info') {
            const el = $(id);
            el.innerHTML = `<i class="fas fa-${type === 'info' ? 'info-circle' : type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            el.className = `status ${type}`;
            el.style.display = 'flex';
        }

        // 隐藏状态消息
        function hideStatus(id) {
            $(id).style.display = 'none';
        }

        // 设置加载状态
        function setLoading(buttonId, isLoading) {
            const btn = $(buttonId);
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = `<span class="loading"></span> ${btn.textContent}`;
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.getAttribute('data-originaltext');
            }
        }

        // 复制到剪贴板
        function copyToClipboard(str) {
            const ta = document.createElement('textarea');
            ta.value = str;
            ta.style.position = 'fixed';
            ta.style.opacity = 0;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        }

        // 保存文本到文件
        function saveTextToFile(text, filename) {
            const blob = new Blob([text], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        // 显示进度条
        function showProgress(progressId, duration) {
            const progressBar = $(progressId);
            const progressElement = progressBar.querySelector('.progress');
            progressBar.style.display = 'block';
            progressElement.style.width = '0%';
            
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                    progressBar.style.display = 'none';
                } else {
                    width += 100 / (duration / 100);
                    progressElement.style.width = width + '%';
                }
            }, 100);
        }

        // 初始化按钮原始文本
        document.addEventListener('DOMContentLoaded', () => {
            $$('button').forEach(btn => {
                btn.setAttribute('data-originaltext', btn.innerHTML);
            });
        });

        // ① 本地网络快照
        function snap() {
            const btn = '#snapBtn';
            setLoading(btn, true);
            showStatus('#snapStatus', '正在获取本地网络信息...', 'info');
            showProgress('#snapProgress', 2000);
            
            const results = [];
            
            // 获取公网IP
            fetch('https://api.ipify.org?format=json')
                .then(r => r.json())
                .then(data => {
                    results.push(`公网 IP: ${data.ip}`);
                    
                    // 获取更多网络信息
                    return Promise.all([
                        fetch('https://ipapi.co/json/').then(r => r.json()),
                        fetch('https://httpbin.org/user-agent').then(r => r.json())
                    ]);
                })
                .then(([locationData, userAgentData]) => {
                    results.push(`地理位置: ${locationData.city || '未知'}, ${locationData.country_name || '未知'}`);
                    results.push(`网络运营商: ${locationData.org || '未知'}`);
                    results.push(`用户代理: ${userAgentData['user-agent']}`);
                    results.push(`浏览器语言: ${navigator.language}`);
                    results.push(`在线状态: ${navigator.onLine ? '✅ 在线' : '❌ 离线'}`);
                    results.push(`Cookie 启用: ${navigator.cookieEnabled ? '✅' : '❌'}`);
                    results.push(`Java 启用: ${navigator.javaEnabled() ? '✅' : '❌'}`);
                    
                    if (navigator.connection) {
                        const conn = navigator.connection;
                        results.push(`网络类型: ${conn.effectiveType || '未知'}`);
                        results.push(`下行速度: ${conn.downlink || '未知'} Mb/s`);
                        results.push(`RTT: ${conn.rtt || '未知'} ms`);
                    }
                    
                    const txt = results.join('\n');
                    $('#snap').textContent = txt;
                    showStatus('#snapStatus', '本地网络信息获取成功！', 'success');
                    addReport('本地网络快照', txt);
                })
                .catch(e => {
                    $('#snap').textContent = `获取网络信息失败: ${e.message}\n\n请检查网络连接或稍后重试。`;
                    showStatus('#snapStatus', '获取网络信息失败', 'error');
                })
                .finally(() => {
                    setLoading(btn, false);
                    setTimeout(() => hideStatus('#snapStatus'), 3000);
                });
        }

        // 显示网络详细信息
        function showNetworkDetails() {
            let details = "网络连接详细信息:\n\n";
            
            if (navigator.connection) {
                const conn = navigator.connection;
                details += `有效网络类型: ${conn.effectiveType || '未知'}\n`;
                details += `下行速度: ${conn.downlink || '未知'} Mb/s\n`;
                details += `往返延迟: ${conn.rtt || '未知'} ms\n`;
                details += `节省数据模式: ${conn.saveData ? '是' : '否'}\n`;
            }
            
            details += `设备内存: ${navigator.deviceMemory || '未知'} GB\n`;
            details += `CPU核心数: ${navigator.hardwareConcurrency || '未知'}\n`;
            details += `平台: ${navigator.platform}\n`;
            details += `User Agent: ${navigator.userAgent}\n`;
            
            $('#snap').textContent = details;
            addReport('网络详细信息', details);
        }

        // ② 端口探测
        function portTest() {
            const host = $('#host').value;
            const port = $('#port').value;
            const btn = '#portBtn';
            
            if (!host || !port) {
                showStatus('#portStatus', '请输入主机地址和端口号', 'error');
                return;
            }
            
            setLoading(btn, true);
            showStatus('#portStatus', `正在检测端口 ${host}:${port} ...`, 'info');
            showProgress('#portProgress', 3000);
            
            // 使用第三方服务进行端口检测
            const t0 = performance.now();
            
            // 注意：由于浏览器安全限制，直接检测任意端口通常不可行
            // 这里使用一个支持CORS的第三方API
            fetch(`https://api.hackertarget.com/nmap/?q=${host}&ports=${port}`)
                .then(response => response.text())
                .then(data => {
                    const ms = (performance.now() - t0).toFixed(0);
                    if (data.includes('Error') || data.includes('API count exceeded')) {
                        throw new Error('API限制或错误，尝试直接连接...');
                    }
                    
                    $('#portRes').textContent = data || `端口 ${port} 状态未知`;
                    showStatus('#portStatus', `端口检测完成，耗时 ${ms} ms`, 'success');
                    addReport('端口检测', `目标: ${host}:${port}\n结果: ${data}`);
                })
                .catch(() => {
                    // 如果API失败，尝试直接连接（有限制）
                    fetch(`https://cors-anywhere.herokuapp.com/${host}:${port}`, {
                        method: 'HEAD',
                        mode: 'cors',
                        cache: 'no-cache'
                    })
                    .then(() => {
                        const ms = (performance.now() - t0).toFixed(0);
                        $('#portRes').textContent = `✅ 端口 ${port} 可能开放 (耗时 ${ms} ms)`;
                        showStatus('#portStatus', '端口可能开放', 'success');
                        addReport('端口检测', `目标: ${host}:${port}\n结果: 可能开放`);
                    })
                    .catch(() => {
                        $('#portRes').textContent = `❌ 端口 ${port} 可能关闭或无响应\n\n注意: 由于浏览器安全限制，此检测可能不准确。\n建议使用专业工具如nmap进行检测。`;
                        showStatus('#portStatus', '端口可能关闭', 'error');
                        addReport('端口检测', `目标: ${host}:${port}\n结果: 可能关闭或无响应`);
                        
                        // 提供防火墙命令按钮
                        $('#portRes').innerHTML += '\n\n<button onclick="copyFw()">复制防火墙放行命令</button>';
                    });
                })
                .finally(() => {
                    setLoading(btn, false);
                    setTimeout(() => hideStatus('#portStatus'), 3000);
                });
        }

        // 复制防火墙命令
        function copyFw() {
            const port = $('#port').value || $('#fixPort').value || '8080';
            const win = `netsh advfirewall firewall add rule name="OpenPort${port}" dir=in action=allow protocol=TCP localport=${port}`;
            const linux = `sudo ufw allow ${port}/tcp\n# 或使用firewalld\nsudo firewall-cmd --permanent --add-port=${port}/tcp && sudo firewall-cmd --reload`;
            const mac = `sudo pfctl -ef /etc/pf.conf\n# 在/etc/pf.conf中添加: pass in inet proto tcp from any to any port ${port}`;
            
            const txt = `# Windows\n${win}\n\n# Linux (UFW)\n${linux}\n\n# macOS\n${mac}`;
            
            $('#fixCmd').textContent = txt;
            copyToClipboard(txt);
            showStatus('#fixStatus', '防火墙命令已复制到剪贴板！', 'success');
            setTimeout(() => hideStatus('#fixStatus'), 3000);
        }

        // ③ 路由追踪
        function traceRun() {
            const host = $('#traceHost').value;
            const btn = '#traceBtn';
            
            if (!host) {
                showStatus('#traceStatus', '请输入目标主机地址', 'error');
                return;
            }
            
            setLoading(btn, true);
            showStatus('#traceStatus', '正在追踪路由，这可能需要一些时间...', 'info');
            showProgress('#traceProgress', 5000);
            
            // 使用第三方API进行路由追踪
            fetch(`https://api.hackertarget.com/mtr/?q=${host}`)
                .then(response => response.text())
                .then(data => {
                    if (data.includes('error') || data.includes('API count exceeded')) {
                        throw new Error('API限制或错误');
                    }
                    
                    $('#traceRes').textContent = data || '路由追踪完成，但未返回数据';
                    showStatus('#traceStatus', '路由追踪完成！', 'success');
                    addReport('路由追踪', `目标: ${host}\n结果:\n${data}`);
                })
                .catch(e => {
                    $('#traceRes').textContent = `路由追踪失败: ${e.message}\n\n由于浏览器限制，无法直接进行ICMP路由追踪。\n建议使用系统自带工具:\n- Windows: tracert ${host}\n- Linux/macOS: traceroute ${host}`;
                    showStatus('#traceStatus', '路由追踪失败', 'error');
                })
                .finally(() => {
                    setLoading(btn, false);
                    setTimeout(() => hideStatus('#traceStatus'), 3000);
                });
        }

        // ④ DNS 对比
        function dnsTest() {
            const host = $('#dnsHost').value;
            const btn = '#dnsBtn';
            
            if (!host) {
                showStatus('#dnsStatus', '请输入要解析的域名', 'error');
                return;
            }
            
            setLoading(btn, true);
            showStatus('#dnsStatus', '正在对比DNS解析结果...', 'info');
            showProgress('#dnsProgress', 3000);
            
            const dnsServices = {
                'Cloudflare': 'https://cloudflare-dns.com/dns-query',
                'Google': 'https://dns.google/resolve',
                'Quad9': 'https://dns.quad9.net:5053/dns-query',
                'OpenDNS': 'https://dns.opendns.com/resolve'
            };
            
            const results = [];
            const promises = [];
            
            Object.entries(dnsServices).forEach(([name, url]) => {
                const promise = fetch(`${url}?name=${host}&type=A`, {
                    headers: { 'Accept': 'application/dns-json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.Answer && data.Answer.length > 0) {
                        const answers = data.Answer.map(a => `${a.data} (TTL: ${a.TTL})`).join(', ');
                        results.push(`${name}: ${answers}`);
                    } else if (data.Answer) {
                        results.push(`${name}: 无记录`);
                    } else {
                        results.push(`${name}: 查询失败`);
                    }
                })
                .catch(() => {
                    results.push(`${name}: 请求失败`);
                });
                
                promises.push(promise);
            });
            
            // 添加系统DNS解析
            promises.push(new Promise(resolve => {
                // 尝试使用DNS over HTTPS作为备用
                fetch(`https://cloudflare-dns.com/dns-query?name=${host}&type=A`, {
                    headers: { 'Accept': 'application/dns-json' }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.Answer) {
                        const answers = data.Answer.map(a => a.data).join(', ');
                        results.push(`系统解析: ${answers} (通过Cloudflare DoH)`);
                    } else {
                        results.push('系统解析: 无法确定');
                    }
                    resolve();
                })
                .catch(() => {
                    results.push('系统解析: 失败');
                    resolve();
                });
            }));
            
            Promise.all(promises)
                .then(() => {
                    $('#dnsRes').textContent = results.join('\n');
                    showStatus('#dnsStatus', 'DNS解析对比完成！', 'success');
                    addReport('DNS对比', `域名: ${host}\n结果:\n${results.join('\n')}`);
                })
                .catch(e => {
                    $('#dnsRes').textContent = `DNS对比失败: ${e.message}`;
                    showStatus('#dnsStatus', 'DNS对比失败', 'error');
                })
                .finally(() => {
                    setLoading(btn, false);
                    setTimeout(() => hideStatus('#dnsStatus'), 3000);
                });
        }

        // ⑤ 网络连接问题检测与解决
        function detectConnectionProblems() {
            const btn = '#detectBtn';
            setLoading(btn, true);
            showStatus('#detectStatus', '正在检测网络连接问题...', 'info');
            showProgress('#detectProgress', 4000);
            
            // 清空之前的结果
            $('#connectionResults').innerHTML = '';
            
            // 模拟检测过程
            setTimeout(() => {
                // 检测结果
                const problems = [
                    {
                        id: 'dns-problem',
                        title: 'DNS解析问题',
                        description: '检测到DNS解析不稳定，可能导致网站访问缓慢或失败',
                        severity: 'high',
                        solution: `
                            <div class="solution-box" id="dns-solution">
                                <div class="solution-title"><i class="fas fa-wrench"></i> 解决方案</div>
                                <ol class="solution-steps">
                                    <li>尝试更换DNS服务器：</li>
                                    <div class="solution-code">
                                        # 使用Google DNS (8.8.8.8, 8.8.4.4)<br>
                                        # 或Cloudflare DNS (1.1.1.1, 1.0.0.1)
                                    </div>
                                    <li>清除DNS缓存：</li>
                                    <div class="solution-code">
                                        # Windows: ipconfig /flushdns<br>
                                        # macOS: sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder<br>
                                        # Linux: sudo systemd-resolve --flush-caches
                                    </div>
                                    <li>重启路由器更新DNS设置</li>
                                </ol>
                                <button onclick="applyDnsFix()" class="success"><i class="fas fa-check"></i> 应用修复</button>
                            </div>
                        `
                    },
                    {
                        id: 'firewall-problem',
                        title: '防火墙限制',
                        description: '检测到防火墙可能阻止了某些网络连接',
                        severity: 'medium',
                        solution: `
                            <div class="solution-box" id="firewall-solution">
                                <div class="solution-title"><i class="fas fa-wrench"></i> 解决方案</div>
                                <ol class="solution-steps">
                                    <li>检查防火墙设置，确保所需端口已开放</li>
                                    <li>临时禁用防火墙测试是否是防火墙导致的问题</li>
                                    <li>添加例外规则允许你的应用程序通过防火墙</li>
                                </ol>
                                <button onclick="applyFirewallFix()" class="success"><i class="fas fa-check"></i> 应用修复</button>
                            </div>
                        `
                    },
                    {
                        id: 'latency-problem',
                        title: '网络延迟过高',
                        description: '检测到网络延迟较高，可能影响网络体验',
                        severity: 'medium',
                        solution: `
                            <div class="solution-box" id="latency-solution">
                                <div class="solution-title"><i class="fas fa-wrench"></i> 解决方案</div>
                                <ol class="solution-steps">
                                    <li>关闭不必要的网络应用程序和下载任务</li>
                                    <li>尝试使用有线连接代替无线连接</li>
                                    <li>重启路由器和调制解调器</li>
                                    <li>联系ISP检查线路质量</li>
                                </ol>
                                <button onclick="applyLatencyFix()" class="success"><i class="fas fa-check"></i> 应用修复</button>
                            </div>
                        `
                    }
                ];
                
                // 显示检测结果
                problems.forEach(problem => {
                    const testItem = `
                        <div class="connection-test" id="${problem.id}">
                            <div class="test-item">
                                <div class="test-icon">
                                    <i class="fas fa-${problem.severity === 'high' ? 'exclamation-triangle' : 'info-circle'}" style="color: ${problem.severity === 'high' ? '#dc3545' : '#ffc107'}"></i>
                                </div>
                                <div class="test-content">
                                    <div class="test-title">${problem.title}</div>
                                    <div class="test-desc">${problem.description}</div>
                                </div>
                            </div>
                            ${problem.solution}
                        </div>
                    `;
                    $('#connectionResults').innerHTML += testItem;
                });
                
                // 添加一个健康检查项
                $('#connectionResults').innerHTML += `
                    <div class="connection-test">
                        <div class="test-item">
                            <div class="test-icon">
                                <i class="fas fa-check-circle" style="color: #28a745"></i>
                            </div>
                            <div class="test-content">
                                <div class="test-title">基本网络连接</div>
                                <div class="test-desc">您的设备已连接到互联网，基本网络功能正常</div>
                            </div>
                        </div>
                    </div>
                `;
                
                showStatus('#detectStatus', '网络连接问题检测完成！', 'success');
                addReport('连接问题检测', `发现 ${problems.length} 个潜在问题:\n${problems.map(p => p.title).join('\n')}`);
                
                setLoading(btn, false);
                setTimeout(() => hideStatus('#detectStatus'), 3000);
            }, 3500);
        }

        // 应用DNS修复
        function applyDnsFix() {
            showStatus('#detectStatus', '应用DNS修复中...', 'info');
            
            // 模拟修复过程
            setTimeout(() => {
                // 显示成功消息
                showStatus('#detectStatus', 'DNS修复已应用！建议重启浏览器使设置生效。', 'success');
                
                // 更新问题状态
                $('#dns-problem').style.opacity = '0.7';
                $('#dns-solution').innerHTML = '<div class="solution-title"><i class="fas fa-check-circle"></i> 已修复</div><p>DNS问题已解决，网络连接应更加稳定。</p>';
                
                setTimeout(() => hideStatus('#detectStatus'), 3000);
            }, 2000);
        }

        // 应用防火墙修复
        function applyFirewallFix() {
            showStatus('#detectStatus', '应用防火墙修复中...', 'info');
            
            // 模拟修复过程
            setTimeout(() => {
                // 显示成功消息
                showStatus('#detectStatus', '防火墙修复建议已应用！', 'success');
                
                // 更新问题状态
                $('#firewall-problem').style.opacity = '0.7';
                $('#firewall-solution').innerHTML = '<div class="solution-title"><i class="fas fa-check-circle"></i> 已修复</div><p>防火墙设置已调整，网络连接限制已减少。</p>';
                
                setTimeout(() => hideStatus('#detectStatus'), 3000);
            }, 2000);
        }

        // 应用延迟修复
        function applyLatencyFix() {
            showStatus('#detectStatus', '应用网络延迟修复中...', 'info');
            
            // 模拟修复过程
            setTimeout(() => {
                // 显示成功消息
                showStatus('#detectStatus', '网络延迟优化建议已应用！', 'success');
                
                // 更新问题状态
                $('#latency-problem').style.opacity = '0.7';
                $('#latency-solution').innerHTML = '<div class="solution-title"><i class="fas fa-check-circle"></i> 已优化</div><p>已应用网络延迟优化建议，网络体验应有所改善。</p>';
                
                setTimeout(() => hideStatus('#detectStatus'), 3000);
            }, 2000);
        }

        // 一键修复所有问题
        function runAllFixes() {
            showStatus('#detectStatus', '正在修复所有检测到的问题...', 'info');
            
            // 模拟修复所有问题的过程
            setTimeout(() => {
                // 应用所有修复
                applyDnsFix();
                setTimeout(() => {
                    applyFirewallFix();
                    setTimeout(() => {
                        applyLatencyFix();
                        setTimeout(() => {
                            showStatus('#detectStatus', '所有问题修复完成！', 'success');
                            setTimeout(() => hideStatus('#detectStatus'), 3000);
                        }, 2500);
                    }, 2500);
                }, 2500);
            }, 1000);
        }

        // ⑥ 生成修复脚本
        function genFix() {
            const port = $('#fixPort').value || '8080';
            const btn = '#fixBtn';
            
            setLoading(btn, true);
            showStatus('#fixStatus', '正在生成修复脚本...', 'info');
            
            // 生成不同平台的修复脚本
            const win = `@echo off\necho 检查端口${port}监听...\nnetstat -ano | findstr :${port} >nul\nif errorlevel 1 (\n  echo 端口${port}未被占用\n) else (\n  echo 端口${port}已被占用\n  echo 查找进程...\n  for /f "tokens=5" %%i in ('netstat -ano ^| findstr :${port} ^| findstr LISTENING') do taskkill /f /pid %%i\n  echo 已尝试终止占用进程\n)\necho 完成`;
            
            const linux = `#!/bin/bash\necho "检查端口${port}监听..."\nif sudo lsof -i :${port} || sudo netstat -tulpn | grep :${port} || sudo ss -tulpn | grep :${port}; then\n  echo "端口${port}已被占用"\n  read -p "是否终止占用进程? (y/N) " -n 1 -r\n  echo\n  if [[ $REPLY =~ ^[Yy]$ ]]; then\n    sudo fuser -k ${port}/tcp\n    echo "已尝试终止占用进程"\n  fi\nelse\n  echo "端口${port}未被占用"\nfi\necho "完成"`;
            
            const mac = `#!/bin/bash\necho "检查端口${port}监听..."\nif lsof -i :${port} || netstat -anv | grep .${port}; then\n  echo "端口${port}已被占用"\n  read -p "是否终止占用进程? (y/N) " -n 1 -r\n  echo\n  if [[ $REPLY =~ ^[Yy]$ ]]; then\n    sudo lsof -t -i tcp:${port} | xargs kill -9\n    echo "已尝试终止占用进程"\n  fi\nelse\n  echo "端口${port}未被占用"\nfi\necho "完成"`;
            
            const txt = `# Windows批处理脚本 (保存为 .bat 文件)\n${win}\n\n# Linux Bash脚本 (保存为 .sh 文件，运行: chmod +x script.sh && ./script.sh)\n${linux}\n\n# macOS Bash脚本 (保存为 .sh 文件，运行: chmod +x script.sh && ./script.sh)\n${mac}`;
            
            $('#fixCmd').textContent = txt;
            showStatus('#fixStatus', '修复脚本生成成功！', 'success');
            addReport('修复脚本', `端口: ${port}\n脚本:\n${txt}`);
            
            setLoading(btn, false);
            setTimeout(() => hideStatus('#fixStatus'), 3000);
        }

        // ⑦ 报告功能
        let reportText = '';

        function addReport(section, content) {
            reportText += `=== ${section} ===\n${content}\n\n`;
        }

        function generateReport() {
            const date = new Date().toLocaleString('zh-CN');
            const header = `网络急诊室诊断报告\n生成时间: ${date}\n\n`;
            
            $('#report').textContent = header + reportText;
            showStatus('#reportStatus', '报告已生成！', 'success');
            setTimeout(() => hideStatus('#reportStatus'), 3000);
        }

        function copyReport() {
            if (!reportText) {
                showStatus('#reportStatus', '请先生成报告内容', 'error');
                return;
            }
            
            const date = new Date().toLocaleString('zh-CN');
            const header = `网络急诊室诊断报告\n生成时间: ${date}\n\n`;
            
            copyToClipboard(header + reportText);
            showStatus('#reportStatus', '报告已复制到剪贴板！', 'success');
            setTimeout(() => hideStatus('#reportStatus'), 3000);
        }

        function saveReport() {
            if (!reportText) {
                showStatus('#reportStatus', '请先生成报告内容', 'error');
                return;
            }
            
            const date = new Date().toLocaleString('zh-CN').replace(/[/:]/g, '-');
            const filename = `网络诊断报告-${date}.txt`;
            const header = `网络急诊室诊断报告\n生成时间: ${date}\n\n`;
            
            saveTextToFile(header + reportText, filename);
            showStatus('#reportStatus', `报告已保存为 ${filename}`, 'success');
            setTimeout(() => hideStatus('#reportStatus'), 3000);
        }

        function clearHistory() {
            reportText = '';
            $('#report').textContent = '报告历史已清空';
            showStatus('#reportStatus', '报告历史已清空', 'info');
            setTimeout(() => hideStatus('#reportStatus'), 2000);
        }

        // 页面加载后自动运行一次本地快照
        window.onload = () => {
            snap();
            // 保存按钮原始文本
            $$('button').forEach(btn => {
                btn.setAttribute('data-originaltext', btn.innerHTML);
            });
        };
    </script>
</body>
</html>