<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>ç½‘ç»œæ€¥è¯Šå®¤ | ä¸€é”®æ£€æµ‹ & ä¿®å¤</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root {
  --primary: #ff5a5f;
  --primary-dark: #e04a50;
  --secondary: #4687ff;
  --light: #f5f5f5;
  --dark: #333;
  --gray: #777;
  --success: #28a745;
  --danger: #dc3545;
  --warning: #ffc107;
  --info: #17a2b8;
}

* {
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
  margin: 0;
  padding: 0;
  background: var(--light);
  color: var(--dark);
  line-height: 1.6;
}

header {
  background: var(--primary);
  color: #fff;
  padding: 1.2rem;
  text-align: center;
  font-size: 1.4rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  position: sticky;
  top: 0;
  z-index: 100;
}

.container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 1rem;
}

.card {
  background: #fff;
  margin-bottom: 1.2rem;
  padding: 1.2rem;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.card-title {
  margin-top: 0;
  font-size: 1.2rem;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.card-number {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  background: var(--primary);
  color: white;
  border-radius: 50%;
  font-size: 0.8rem;
  margin-right: 0.5rem;
}

.input-group {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.8rem;
  flex-wrap: wrap;
  align-items: center;
}

input {
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-family: inherit;
  flex: 1;
  min-width: 120px;
}

button {
  cursor: pointer;
  background: var(--primary);
  color: #fff;
  border: 0;
  padding: 0.6rem 1rem;
  border-radius: 4px;
  font-family: inherit;
  font-weight: 500;
  transition: background 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
}

button:hover {
  background: var(--primary-dark);
}

button.secondary {
  background: var(--secondary);
}

button.secondary:hover {
  background: #3a75e0;
}

pre {
  background: #f8f9fa;
  padding: 1rem;
  border-left: 4px solid var(--primary);
  overflow-x: auto;
  font-size: 0.9rem;
  border-radius: 0 4px 4px 0;
  margin: 0;
  white-space: pre-wrap;
}

.status {
  padding: 0.5rem;
  border-radius: 4px;
  margin-top: 0.5rem;
  display: none;
}

.status.info {
  background: #e8f4fd;
  color: var(--info);
  border-left: 4px solid var(--info);
}

.status.success {
  background: #f0f9f0;
  color: var(--success);
  border-left: 4px solid var(--success);
}

.status.error {
  background: #fdf3f3;
  color: var(--danger);
  border-left: 4px solid var(--danger);
}

.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.flex-row {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.tooltip {
  position: relative;
  display: inline-block;
  margin-left: 0.5rem;
  color: var(--gray);
  cursor: help;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 200px;
  background-color: var(--dark);
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -100px;
  opacity: 0;
  transition: opacity 0.3s;
  font-size: 0.8rem;
  font-weight: normal;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

.copy-btn {
  background: var(--gray);
  font-size: 0.8rem;
  padding: 0.3rem 0.6rem;
}

.copy-btn:hover {
  background: #666;
}

@media (max-width: 768px) {
  .input-group {
    flex-direction: column;
    align-items: stretch;
  }
  
  input {
    width: 100%;
  }
}
</style>
</head>
<body>
<header>ğŸš‘ ç½‘ç»œæ€¥è¯Šå®¤ Â· ä¸€é”®æ£€æµ‹ & ä¿®å¤</header>

<div class="container">
  <section class="card">
    <h2 class="card-title"><span class="card-number">1</span> æœ¬åœ°ç½‘ç»œå¿«ç…§</h2>
    <div class="input-group">
      <button onclick="snap()" id="snapBtn">åˆ·æ–°ç½‘ç»œçŠ¶æ€</button>
    </div>
    <div id="snapStatus" class="status info"></div>
    <pre id="snap"></pre>
  </section>

  <section class="card">
    <h2 class="card-title"><span class="card-number">2</span> ç«¯å£æ¢æµ‹</h2>
    <div class="input-group">
      <input id="host" value="www.example.com" placeholder="åŸŸå/IP">
      <input id="port" value="80" placeholder="ç«¯å£" style="width:100px">
      <button onclick="portTest()" id="portBtn">æ£€æµ‹ç«¯å£</button>
    </div>
    <div id="portStatus" class="status info"></div>
    <pre id="portRes"></pre>
  </section>

  <section class="card">
    <h2 class="card-title"><span class="card-number">3</span> è·¯ç”±è¿½è¸ª</h2>
    <div class="input-group">
      <input id="traceHost" value="www.example.com" placeholder="åŸŸå/IP">
      <button onclick="traceRun()" id="traceBtn">å¼€å§‹è¿½è¸ª</button>
    </div>
    <div id="traceStatus" class="status info"></div>
    <pre id="traceRes"></pre>
  </section>

  <section class="card">
    <h2 class="card-title"><span class="card-number">4</span> DNS å¯¹æ¯” 
      <span class="tooltip">â„¹ï¸
        <span class="tooltiptext">å¯¹æ¯”ä¸åŒDNSæœåŠ¡å•†çš„è§£æç»“æœï¼Œæ£€æµ‹DNSæ±¡æŸ“æˆ–é…ç½®é—®é¢˜</span>
      </span>
    </h2>
    <div class="input-group">
      <input id="dnsHost" value="github.com" placeholder="åŸŸå">
      <button onclick="dnsTest()" id="dnsBtn">è§£æå¯¹æ¯”</button>
    </div>
    <div id="dnsStatus" class="status info"></div>
    <pre id="dnsRes"></pre>
  </section>

  <section class="card">
    <h2 class="card-title"><span class="card-number">5</span> æœ¬åœ°ç›‘å¬è‡ªæµ‹</h2>
    <div class="input-group">
      <input id="listenPort" value="8080" placeholder="ç«¯å£" style="width:100px">
      <button onclick="listenTest()" id="listenBtn">æ£€æµ‹ç«¯å£ç›‘å¬</button>
    </div>
    <div id="listenStatus" class="status info"></div>
    <pre id="listenRes"></pre>
  </section>

  <section class="card">
    <h2 class="card-title"><span class="card-number">6</span> ç”Ÿæˆä¿®å¤è„šæœ¬</h2>
    <div class="input-group">
      <input id="fixPort" value="8080" placeholder="ç«¯å£" style="width:100px">
      <button onclick="genFix()" id="fixBtn">ç”Ÿæˆè„šæœ¬</button>
      <button onclick="copyFw()" class="secondary">å¤åˆ¶é˜²ç«å¢™å‘½ä»¤</button>
    </div>
    <div id="fixStatus" class="status info"></div>
    <pre id="fixCmd"></pre>
  </section>

  <section class="card">
    <h2 class="card-title"><span class="card-number">7</span> å®Œæ•´æŠ¥å‘Š</h2>
    <div class="input-group">
      <button onclick="generateReport()" class="secondary">ç”ŸæˆæŠ¥å‘Š</button>
      <button onclick="copyReport()">å¤åˆ¶æŠ¥å‘Š</button>
      <button onclick="saveReport()" class="secondary">ä¿å­˜æŠ¥å‘Š</button>
    </div>
    <div id="reportStatus" class="status info"></div>
    <pre id="report"></pre>
  </section>
</div>

<script>
// å·¥å…·å‡½æ•°
const $ = q => document.querySelector(q);
const $$ = q => document.querySelectorAll(q);

function showStatus(id, message, type = 'info') {
  const el = $(id);
  el.textContent = message;
  el.className = `status ${type}`;
  el.style.display = 'block';
}

function hideStatus(id) {
  $(id).style.display = 'none';
}

function setLoading(button, isLoading) {
  const btn = $(button);
  if (isLoading) {
    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­...';
  } else {
    btn.disabled = false;
    btn.innerHTML = btn.getAttribute('data-originaltext');
  }
}

function saveTextToFile(text, filename) {
  const blob = new Blob([text], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 100);
}

function copyToClipboard(str) {
  const ta = document.createElement('textarea');
  ta.value = str;
  ta.style.position = 'fixed';
  ta.style.opacity = 0;
  document.body.appendChild(ta);
  ta.select();
  document.execCommand('copy');
  document.body.removeChild(ta);
}

// å­˜å‚¨åŸå§‹æŒ‰é’®æ–‡æœ¬
document.addEventListener('DOMContentLoaded', () => {
  $$('button').forEach(btn => {
    btn.setAttribute('data-originaltext', btn.innerHTML);
  });
});

// â‘  æœ¬åœ°å¿«ç…§
function snap() {
  const btn = '#snapBtn';
  setLoading(btn, true);
  showStatus('#snapStatus', 'æ­£åœ¨è·å–æœ¬åœ°ç½‘ç»œä¿¡æ¯...', 'info');
  
  const results = [];
  
  // è·å–å…¬ç½‘IP
  fetch('https://api.ipify.org?format=json')
    .then(r => r.json())
    .then(data => {
      results.push(`å…¬ç½‘ IP: ${data.ip}`);
      
      // è·å–æ›´å¤šç½‘ç»œä¿¡æ¯
      return Promise.all([
        fetch('https://ipapi.co/json/').then(r => r.json()),
        fetch('https://httpbin.org/user-agent').then(r => r.json())
      ]);
    })
    .then(([locationData, userAgentData]) => {
      results.push(`åœ°ç†ä½ç½®: ${locationData.city || 'æœªçŸ¥'}, ${locationData.country_name || 'æœªçŸ¥'}`);
      results.push(`ç½‘ç»œè¿è¥å•†: ${locationData.org || 'æœªçŸ¥'}`);
      results.push(`ç”¨æˆ·ä»£ç†: ${userAgentData['user-agent']}`);
      results.push(`æµè§ˆå™¨è¯­è¨€: ${navigator.language}`);
      results.push(`åœ¨çº¿çŠ¶æ€: ${navigator.onLine ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿'}`);
      results.push(`Cookie å¯ç”¨: ${navigator.cookieEnabled ? 'âœ…' : 'âŒ'}`);
      results.push(`Java å¯ç”¨: ${navigator.javaEnabled() ? 'âœ…' : 'âŒ'}`);
      
      if (navigator.connection) {
        const conn = navigator.connection;
        results.push(`ç½‘ç»œç±»å‹: ${conn.effectiveType || 'æœªçŸ¥'}`);
        results.push(`ä¸‹è¡Œé€Ÿåº¦: ${conn.downlink || 'æœªçŸ¥'} Mb/s`);
        results.push(`RTT: ${conn.rtt || 'æœªçŸ¥'} ms`);
      }
      
      const txt = results.join('\n');
      $('#snap').textContent = txt;
      showStatus('#snapStatus', 'æœ¬åœ°ç½‘ç»œä¿¡æ¯è·å–æˆåŠŸï¼', 'success');
      addReport('æœ¬åœ°ç½‘ç»œå¿«ç…§', txt);
    })
    .catch(e => {
      $('#snap').textContent = `è·å–ç½‘ç»œä¿¡æ¯å¤±è´¥: ${e.message}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚`;
      showStatus('#snapStatus', 'è·å–ç½‘ç»œä¿¡æ¯å¤±è´¥', 'error');
    })
    .finally(() => {
      setLoading(btn, false);
      setTimeout(() => hideStatus('#snapStatus'), 3000);
    });
}

// â‘¡ ç«¯å£æ¢æµ‹
function portTest() {
  const host = $('#host').value;
  const port = $('#port').value;
  const btn = '#portBtn';
  
  if (!host || !port) {
    showStatus('#portStatus', 'è¯·è¾“å…¥ä¸»æœºåœ°å€å’Œç«¯å£å·', 'error');
    return;
  }
  
  setLoading(btn, true);
  showStatus('#portStatus', `æ­£åœ¨æ£€æµ‹ç«¯å£ ${host}:${port} ...`, 'info');
  
  // ä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡è¿›è¡Œç«¯å£æ£€æµ‹
  const t0 = performance.now();
  
  // æ³¨æ„ï¼šç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œç›´æ¥æ£€æµ‹ä»»æ„ç«¯å£é€šå¸¸ä¸å¯è¡Œ
  // è¿™é‡Œä½¿ç”¨ä¸€ä¸ªæ”¯æŒCORSçš„ç¬¬ä¸‰æ–¹API
  fetch(`https://api.hackertarget.com/nmap/?q=${host}&ports=${port}`)
    .then(response => response.text())
    .then(data => {
      const ms = (performance.now() - t0).toFixed(0);
      if (data.includes('Error') || data.includes('API count exceeded')) {
        throw new Error('APIé™åˆ¶æˆ–é”™è¯¯ï¼Œå°è¯•ç›´æ¥è¿æ¥...');
      }
      
      $('#portRes').textContent = data || `ç«¯å£ ${port} çŠ¶æ€æœªçŸ¥`;
      showStatus('#portStatus', `ç«¯å£æ£€æµ‹å®Œæˆï¼Œè€—æ—¶ ${ms} ms`, 'success');
      addReport('ç«¯å£æ£€æµ‹', `ç›®æ ‡: ${host}:${port}\nç»“æœ: ${data}`);
    })
    .catch(() => {
      // å¦‚æœAPIå¤±è´¥ï¼Œå°è¯•ç›´æ¥è¿æ¥ï¼ˆæœ‰é™åˆ¶ï¼‰
      fetch(`https://cors-anywhere.herokuapp.com/${host}:${port}`, {
        method: 'HEAD',
        mode: 'cors',
        cache: 'no-cache'
      })
      .then(() => {
        const ms = (performance.now() - t0).toFixed(0);
        $('#portRes').textContent = `âœ… ç«¯å£ ${port} å¯èƒ½å¼€æ”¾ (è€—æ—¶ ${ms} ms)`;
        showStatus('#portStatus', 'ç«¯å£å¯èƒ½å¼€æ”¾', 'success');
        addReport('ç«¯å£æ£€æµ‹', `ç›®æ ‡: ${host}:${port}\nç»“æœ: å¯èƒ½å¼€æ”¾`);
      })
      .catch(() => {
        $('#portRes').textContent = `âŒ ç«¯å£ ${port} å¯èƒ½å…³é—­æˆ–æ— å“åº”\n\næ³¨æ„: ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ­¤æ£€æµ‹å¯èƒ½ä¸å‡†ç¡®ã€‚\nå»ºè®®ä½¿ç”¨ä¸“ä¸šå·¥å…·å¦‚nmapè¿›è¡Œæ£€æµ‹ã€‚`;
        showStatus('#portStatus', 'ç«¯å£å¯èƒ½å…³é—­', 'error');
        addReport('ç«¯å£æ£€æµ‹', `ç›®æ ‡: ${host}:${port}\nç»“æœ: å¯èƒ½å…³é—­æˆ–æ— å“åº”`);
        
        // æä¾›é˜²ç«å¢™å‘½ä»¤æŒ‰é’®
        $('#portRes').innerHTML += '\n\n<button onclick="copyFw()">å¤åˆ¶é˜²ç«å¢™æ”¾è¡Œå‘½ä»¤</button>';
      });
    })
    .finally(() => {
      setLoading(btn, false);
      setTimeout(() => hideStatus('#portStatus'), 3000);
    });
}

function copyFw() {
  const port = $('#port').value || $('#fixPort').value || '8080';
  const win = `netsh advfirewall firewall add rule name="OpenPort${port}" dir=in action=allow protocol=TCP localport=${port}`;
  const linux = `sudo ufw allow ${port}/tcp\n# æˆ–ä½¿ç”¨firewalld\nsudo firewall-cmd --permanent --add-port=${port}/tcp && sudo firewall-cmd --reload`;
  const mac = `sudo pfctl -ef /etc/pf.conf\n# åœ¨/etc/pf.confä¸­æ·»åŠ : pass in inet proto tcp from any to any port ${port}`;
  
  const txt = `# Windows\n${win}\n\n# Linux (UFW)\n${linux}\n\n# macOS\n${mac}`;
  
  $('#fixCmd').textContent = txt;
  copyToClipboard(txt);
  showStatus('#fixStatus', 'é˜²ç«å¢™å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
  setTimeout(() => hideStatus('#fixStatus'), 3000);
}

// â‘¢ è·¯ç”±è¿½è¸ª
function traceRun() {
  const host = $('#traceHost').value;
  const btn = '#traceBtn';
  
  if (!host) {
    showStatus('#traceStatus', 'è¯·è¾“å…¥ç›®æ ‡ä¸»æœºåœ°å€', 'error');
    return;
  }
  
  setLoading(btn, true);
  showStatus('#traceStatus', 'æ­£åœ¨è¿½è¸ªè·¯ç”±ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...', 'info');
  
  // ä½¿ç”¨ç¬¬ä¸‰æ–¹APIè¿›è¡Œè·¯ç”±è¿½è¸ª
  fetch(`https://api.hackertarget.com/mtr/?q=${host}`)
    .then(response => response.text())
    .then(data => {
      if (data.includes('error') || data.includes('API count exceeded')) {
        throw new Error('APIé™åˆ¶æˆ–é”™è¯¯');
      }
      
      $('#traceRes').textContent = data || 'è·¯ç”±è¿½è¸ªå®Œæˆï¼Œä½†æœªè¿”å›æ•°æ®';
      showStatus('#traceStatus', 'è·¯ç”±è¿½è¸ªå®Œæˆï¼', 'success');
      addReport('è·¯ç”±è¿½è¸ª', `ç›®æ ‡: ${host}\nç»“æœ:\n${data}`);
    })
    .catch(e => {
      $('#traceRes').textContent = `è·¯ç”±è¿½è¸ªå¤±è´¥: ${e.message}\n\nç”±äºæµè§ˆå™¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥è¿›è¡ŒICMPè·¯ç”±è¿½è¸ªã€‚\nå»ºè®®ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦å·¥å…·:\n- Windows: tracert ${host}\n- Linux/macOS: traceroute ${host}`;
      showStatus('#traceStatus', 'è·¯ç”±è¿½è¸ªå¤±è´¥', 'error');
    })
    .finally(() => {
      setLoading(btn, false);
      setTimeout(() => hideStatus('#traceStatus'), 3000);
    });
}

// â‘£ DNS å¯¹æ¯”
function dnsTest() {
  const host = $('#dnsHost').value;
  const btn = '#dnsBtn';
  
  if (!host) {
    showStatus('#dnsStatus', 'è¯·è¾“å…¥è¦è§£æçš„åŸŸå', 'error');
    return;
  }
  
  setLoading(btn, true);
  showStatus('#dnsStatus', 'æ­£åœ¨å¯¹æ¯”DNSè§£æç»“æœ...', 'info');
  
  const dnsServices = {
    'Cloudflare': 'https://cloudflare-dns.com/dns-query',
    'Google': 'https://dns.google/resolve',
    'Quad9': 'https://dns.quad9.net:5053/dns-query',
    'OpenDNS': 'https://dns.opendns.com/resolve'
  };
  
  const results = [];
  const promises = [];
  
  Object.entries(dnsServices).forEach(([name, url]) => {
    const promise = fetch(`${url}?name=${host}&type=A`, {
      headers: { 'Accept': 'application/dns-json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.Answer && data.Answer.length > 0) {
        const answers = data.Answer.map(a => `${a.data} (TTL: ${a.TTL})`).join(', ');
        results.push(`${name}: ${answers}`);
      } else if (data.Answer) {
        results.push(`${name}: æ— è®°å½•`);
      } else {
        results.push(`${name}: æŸ¥è¯¢å¤±è´¥`);
      }
    })
    .catch(() => {
      results.push(`${name}: è¯·æ±‚å¤±è´¥`);
    });
    
    promises.push(promise);
  });
  
  // æ·»åŠ ç³»ç»ŸDNSè§£æ
  promises.push(new Promise(resolve => {
    // å°è¯•ä½¿ç”¨DNS over HTTPSä½œä¸ºå¤‡ç”¨
    fetch(`https://cloudflare-dns.com/dns-query?name=${host}&type=A`, {
      headers: { 'Accept': 'application/dns-json' }
    })
    .then(r => r.json())
    .then(data => {
      if (data.Answer) {
        const answers = data.Answer.map(a => a.data).join(', ');
        results.push(`ç³»ç»Ÿè§£æ: ${answers} (é€šè¿‡Cloudflare DoH)`);
      } else {
        results.push('ç³»ç»Ÿè§£æ: æ— æ³•ç¡®å®š');
      }
      resolve();
    })
    .catch(() => {
      results.push('ç³»ç»Ÿè§£æ: å¤±è´¥');
      resolve();
    });
  }));
  
  Promise.all(promises)
    .then(() => {
      $('#dnsRes').textContent = results.join('\n');
      showStatus('#dnsStatus', 'DNSè§£æå¯¹æ¯”å®Œæˆï¼', 'success');
      addReport('DNSå¯¹æ¯”', `åŸŸå: ${host}\nç»“æœ:\n${results.join('\n')}`);
    })
    .catch(e => {
      $('#dnsRes').textContent = `DNSå¯¹æ¯”å¤±è´¥: ${e.message}`;
      showStatus('#dnsStatus', 'DNSå¯¹æ¯”å¤±è´¥', 'error');
    })
    .finally(() => {
      setLoading(btn, false);
      setTimeout(() => hideStatus('#dnsStatus'), 3000);
    });
}

// â‘¤ æœ¬åœ°ç›‘å¬æµ‹è¯•
function listenTest() {
  const port = $('#listenPort').value;
  const btn = '#listenBtn';
  
  if (!port) {
    showStatus('#listenStatus', 'è¯·è¾“å…¥è¦æ£€æµ‹çš„ç«¯å£å·', 'error');
    return;
  }
  
  setLoading(btn, true);
  showStatus('#listenStatus', 'æ­£åœ¨æ£€æµ‹æœ¬åœ°ç«¯å£...', 'info');
  
  // ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥æ‰«ææœ¬åœ°ç«¯å£
  // æä¾›æœ‰ç”¨çš„å‘½ä»¤å’ŒæŒ‡å¯¼
  const commands = {
    'Windows': `netstat -ano | findstr :${port}`,
    'Linux/macOS': `sudo lsof -i :${port} || sudo netstat -tulpn | grep :${port} || sudo ss -tulpn | grep :${port}`
  };
  
  const txt = `ç”±äºæµè§ˆå™¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥æ£€æµ‹æœ¬åœ°ç«¯å£ç›‘å¬æƒ…å†µã€‚\n\nè¯·æ ¹æ®æ‚¨çš„ç³»ç»Ÿåœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:\n\nWindows:\n${commands.Windows}\n\nLinux/macOS:\n${commands.Linux}\n\nå¦‚æœå‘½ä»¤æœ‰è¾“å‡ºï¼Œè¡¨ç¤ºè¯¥ç«¯å£æ­£åœ¨è¢«ç›‘å¬ã€‚`;
  
  $('#listenRes').textContent = txt;
  showStatus('#listenStatus', 'è¯·ä½¿ç”¨ç³»ç»Ÿå‘½ä»¤æ£€æµ‹ç«¯å£', 'info');
  addReport('æœ¬åœ°ç«¯å£æ£€æµ‹', `ç«¯å£: ${port}\nå»ºè®®å‘½ä»¤:\n${JSON.stringify(commands, null, 2)}`);
  
  setLoading(btn, false);
  setTimeout(() => hideStatus('#listenStatus'), 3000);
}

// â‘¥ ç”Ÿæˆä¿®å¤è„šæœ¬
function genFix() {
  const port = $('#fixPort').value || '8080';
  const btn = '#fixBtn';
  
  setLoading(btn, true);
  showStatus('#fixStatus', 'æ­£åœ¨ç”Ÿæˆä¿®å¤è„šæœ¬...', 'info');
  
  // ç”Ÿæˆä¸åŒå¹³å°çš„ä¿®å¤è„šæœ¬
  const win = `@echo off\necho æ£€æŸ¥ç«¯å£${port}ç›‘å¬...\nnetstat -ano | findstr :${port} >nul\nif errorlevel 1 (\n  echo ç«¯å£${port}æœªè¢«å ç”¨\n) else (\n  echo ç«¯å£${port}å·²è¢«å ç”¨\n  echo æŸ¥æ‰¾è¿›ç¨‹...\n  for /f "tokens=5" %%i in ('netstat -ano ^| findstr :${port} ^| findstr LISTENING') do taskkill /f /pid %%i\n  echo å·²å°è¯•ç»ˆæ­¢å ç”¨è¿›ç¨‹\n)\necho å®Œæˆ`;
  
  const linux = `#!/bin/bash\necho "æ£€æŸ¥ç«¯å£${port}ç›‘å¬..."\nif sudo lsof -i :${port} || sudo netstat -tulpn | grep :${port} || sudo ss -tulpn | grep :${port}; then\n  echo "ç«¯å£${port}å·²è¢«å ç”¨"\n  read -p "æ˜¯å¦ç»ˆæ­¢å ç”¨è¿›ç¨‹? (y/N) " -n 1 -r\n  echo\n  if [[ $REPLY =~ ^[Yy]$ ]]; then\n    sudo fuser -k ${port}/tcp\n    echo "å·²å°è¯•ç»ˆæ­¢å ç”¨è¿›ç¨‹"\n  fi\nelse\n  echo "ç«¯å£${port}æœªè¢«å ç”¨"\nfi\necho "å®Œæˆ"`;
  
  const mac = `#!/bin/bash\necho "æ£€æŸ¥ç«¯å£${port}ç›‘å¬..."\nif lsof -i :${port} || netstat -anv | grep .${port}; then\n  echo "ç«¯å£${port}å·²è¢«å ç”¨"\n  read -p "æ˜¯å¦ç»ˆæ­¢å ç”¨è¿›ç¨‹? (y/N) " -n 1 -r\n  echo\n  if [[ $REPLY =~ ^[Yy]$ ]]; then\n    sudo lsof -t -i tcp:${port} | xargs kill -9\n    echo "å·²å°è¯•ç»ˆæ­¢å ç”¨è¿›ç¨‹"\n  fi\nelse\n  echo "ç«¯å£${port}æœªè¢«å ç”¨"\nfi\necho "å®Œæˆ"`;
  
  const txt = `# Windowsæ‰¹å¤„ç†è„šæœ¬ (ä¿å­˜ä¸º .bat æ–‡ä»¶)\n${win}\n\n# Linux Bashè„šæœ¬ (ä¿å­˜ä¸º .sh æ–‡ä»¶ï¼Œè¿è¡Œ: chmod +x script.sh && ./script.sh)\n${linux}\n\n# macOS Bashè„šæœ¬ (ä¿å­˜ä¸º .sh æ–‡ä»¶ï¼Œè¿è¡Œ: chmod +x script.sh && ./script.sh)\n${mac}`;
  
  $('#fixCmd').textContent = txt;
  showStatus('#fixStatus', 'ä¿®å¤è„šæœ¬ç”ŸæˆæˆåŠŸï¼', 'success');
  addReport('ä¿®å¤è„šæœ¬', `ç«¯å£: ${port}\nè„šæœ¬:\n${txt}`);
  
  setLoading(btn, false);
  setTimeout(() => hideStatus('#fixStatus'), 3000);
}

// â‘¦ æŠ¥å‘ŠåŠŸèƒ½
let reportText = '';

function addReport(section, content) {
  reportText += `=== ${section} ===\n${content}\n\n`;
}

function generateReport() {
  const date = new Date().toLocaleString('zh-CN');
  const header = `ç½‘ç»œæ€¥è¯Šå®¤è¯Šæ–­æŠ¥å‘Š\nç”Ÿæˆæ—¶é—´: ${date}\n\n`;
  
  $('#report').textContent = header + reportText;
  showStatus('#reportStatus', 'æŠ¥å‘Šå·²ç”Ÿæˆï¼', 'success');
  setTimeout(() => hideStatus('#reportStatus'), 3000);
}

function copyReport() {
  if (!reportText) {
    showStatus('#reportStatus', 'è¯·å…ˆç”ŸæˆæŠ¥å‘Šå†…å®¹', 'error');
    return;
  }
  
  const date = new Date().toLocaleString('zh-CN');
  const header = `ç½‘ç»œæ€¥è¯Šå®¤è¯Šæ–­æŠ¥å‘Š\nç”Ÿæˆæ—¶é—´: ${date}\n\n`;
  
  copyToClipboard(header + reportText);
  showStatus('#reportStatus', 'æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
  setTimeout(() => hideStatus('#reportStatus'), 3000);
}

function saveReport() {
  if (!reportText) {
    showStatus('#reportStatus', 'è¯·å…ˆç”ŸæˆæŠ¥å‘Šå†…å®¹', 'error');
    return;
  }
  
  const date = new Date().toLocaleString('zh-CN').replace(/[/:]/g, '-');
  const filename = `ç½‘ç»œè¯Šæ–­æŠ¥å‘Š-${date}.txt`;
  const header = `ç½‘ç»œæ€¥è¯Šå®¤è¯Šæ–­æŠ¥å‘Š\nç”Ÿæˆæ—¶é—´: ${date}\n\n`;
  
  saveTextToFile(header + reportText, filename);
  showStatus('#reportStatus', `æŠ¥å‘Šå·²ä¿å­˜ä¸º ${filename}`, 'success');
  setTimeout(() => hideStatus('#reportStatus'), 3000);
}

// é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œä¸€æ¬¡æœ¬åœ°å¿«ç…§
window.onload = () => {
  snap();
  // ä¿å­˜æŒ‰é’®åŸå§‹æ–‡æœ¬
  $$('button').forEach(btn => {
    btn.setAttribute('data-originaltext', btn.innerHTML);
  });
};
</script>
</body>
</html>
